#  钉钉单点登录（SSO）对接配置说明

## 准备工作

配置SSO登录前，您需要完成以下工作：

### 1. 确保企业满足以下条件

- 拥有钉钉企业账号，并已完成企业认证
- 拥有钉钉管理员权限（应用管理权限）
- 确保钉钉通讯录中已录入需要使用SSO登录的员工信息

### 2. 规划配置数据

| 配置项            | 示例值                    | 说明                             |
| ----------------- | ------------------------- | -------------------------------- |
| 企业钉钉CorpId    | ding1234567890            | 企业唯一标识，在钉钉管理后台查看 |
| 钉钉应用AppKey    | dingabcd1234              | 创建钉钉应用后获得               |
| 钉钉应用AppSecret | xyz789abcdef              | 创建钉钉应用后获得               |
| 回调域名          | https://your-domain.com   | 您的平台访问域名                 |
| 用户标识字段      | userId / unionId / mobile | 确定用于匹配用户的唯一字段       |

### 重要说明

本文中涉及到的钉钉应用创建和配置属于第三方平台操作，仅用于帮助理解端到端配置流程。关于钉钉开放平台的详细操作，请参考[钉钉官方文档](https://open.dingtalk.com/)。如遇钉钉配置问题，建议联系钉钉技术支持。

## 步骤一：在钉钉开放平台创建并配置应用

钉钉在此流程中作为身份提供方（IdP），需要创建应用并建立信任关系。

### 1. 登录钉钉开放平台

- 访问 [钉钉开放平台](https://open-dev.dingtalk.com/)
- 使用企业管理员账号登录

### 2. 创建企业内部应用

1. 进入"应用开发" → "企业内部开发"
2. 点击"创建应用"，选择"H5微应用"
3. 填写应用基本信息：
   - 应用名称：例如"[您的产品名]单点登录"
   - 应用描述：用于员工单点登录认证
   - 应用图标：上传标识性图标

### 3. 获取应用凭证

创建成功后，在应用详情页获取以下关键信息：

- **AppKey**：应用唯一标识Key
- **AppSecret**：应用密钥，请妥善保管
- **CorpId**：企业ID（在开放平台首页查看）

### 4. 配置应用权限

1. 进入"权限管理"页面
2. 添加以下接口权限：
   - **成员信息读权限**（必需）：获取用户基本信息
   - **手机号码信息**（可选）：获取用户手机号
   - **邮箱等个人信息**（可选）：获取用户邮箱
3. 提交申请并等待审核通过（通常自动通过）

### 5. 配置回调地址

1. 进入"开发管理"页面
2. 在"服务器出口IP"中填写您的服务器IP地址
3. 在"H5微应用"区域设置：
   - 首页地址：`https://your-domain.com`
   - 管理后台地址：`https://your-domain.com/admin`
4. 重要：记录以下回调URL（将在下一步使用）：

OAuth回调域名：[https://your-domain.com](https://your-domain.com/)
具体回调路径请参考下一步控制台显示

## 步骤二：在平台管理控制台配置钉钉为可信身份源

在您的平台（服务提供方SP）中配置钉钉信息，建立信任关系。

### 1. 登录平台管理控制台

- 使用管理员账号登录您的平台
- 进入"安全设置" → "单点登录配置"

### 2. 添加钉钉身份源

1. 点击"添加身份源"或"新建配置"
2. 选择身份源类型："钉钉"
3. 填写从钉钉开放平台获取的配置信息：

| 字段             | 填写内容                |
| ---------------- | ----------------------- |
| 身份源名称       | 钉钉企业单点登录        |
| CorpId（企业ID） | 填写您的钉钉CorpId      |
| AppKey           | 填写钉钉应用的AppKey    |
| AppSecret        | 填写钉钉应用的AppSecret |

### 3. 配置回调地址

1. 系统会自动生成回调URL，格式通常为：https://your-domain.com/api/auth/dingtalk/callback

   2. **重要**：将此完整回调URL复制到钉钉应用配置中（如钉钉要求填写具体回调URL）

   ### 4. 配置用户属性映射

   为了让平台能正确识别并匹配用户，需要配置SAML断言（用户信息）的属性映射：

   | 平台用户字段 | 建议的钉钉字段 | 说明                     |
   | ------------ | -------------- | ------------------------ |
   | 用户唯一标识 | userId         | 钉钉用户唯一ID，推荐使用 |
   | 用户姓名     | name           | 用户在钉钉中的姓名       |
   | 手机号       | mobile         | 用户手机号（需申请权限） |
   | 邮箱         | email          | 用户邮箱（需申请权限）   |
   | 部门         | department     | 用户所在部门             |

   ### 5. 测试连接并启用

   1. 点击"测试连接"验证配置是否正确
   2. 如果测试成功，保存配置
   3. 启用该身份源配置

   ## 步骤三：配置用户标识映射规则

   为了让平台能使用SSO响应定位到正确的用户，需要确保用户标识在双方系统中一致。

   ### 1. 理解用户标识匹配

   平台需要将钉钉返回的用户标识与本地用户库匹配。有以下几种方案：

   #### 方案一：使用钉钉userId作为唯一标识（推荐）

   - **适用场景**：平台新建用户体系，或允许自动创建用户
   - **配置方法**：

   1. 在平台用户属性映射中，将"用户唯一标识"映射为钉钉的`userId`
   2. 平台在首次SSO登录时，使用`userId`创建新用户
   3. 后续登录通过`userId`匹配用户

   #### 方案二：使用手机号匹配现有用户

   - **适用场景**：平台已有用户体系，且用户手机号已录入
   - **配置方法**：

   1. 在钉钉申请"手机号码信息"权限
   2. 在平台用户属性映射中，将"用户唯一标识"映射为钉钉的`mobile`
   3. 确保平台用户手机号与钉钉通讯录手机号一致
   4. **注意**：需处理手机号隐私设置问题

   #### 方案三：使用邮箱匹配现有用户

   - **适用场景**：平台已有用户体系，且用户邮箱已录入
   - **配置方法**：

   1. 在钉钉申请"邮箱等个人信息"权限
   2. 在平台用户属性映射中，将"用户唯一标识"映射为钉钉的`email`
   3. 确保平台用户邮箱与钉钉通讯录邮箱一致

   ### 2. 配置额外属性同步（可选）

   除了用户标识，还可以配置其他属性同步：

   1. **角色/职位映射**：

   - 将钉钉中的职位信息映射到平台角色
   - 例如：钉钉"部门主管" → 平台"管理员"

   2. **部门信息同步**：

   - 同步部门结构，用于权限分组
   - 支持多部门用户处理

   ### 3. 测试用户登录

   1. 在浏览器中访问您的平台登录页
   2. 点击"钉钉单点登录"按钮
   3. 系统应重定向到钉钉登录页
   4. 使用钉钉账号登录并授权
   5. 验证是否成功登录到平台
   6. 验证用户信息是否正确同步

   ## 故障排查

   ### 常见问题

   1. **点击登录后无反应或报错**

   - 检查钉钉应用是否已发布
   - 检查回调URL配置是否正确（双方都要检查）
   - 检查服务器出口IP是否已配置

   2. **登录后提示"用户不存在"**

   - 检查用户属性映射配置
   - 确认使用的标识字段（userId/手机号/邮箱）在平台中存在
   - 检查钉钉通讯录中该用户信息是否完整

   3. **权限不足错误**

   - 检查钉钉应用权限是否已申请并通过
   - 确认登录的钉钉账号在企业通讯录中

   ### 获取支持

   如遇到配置问题，请联系我们：

   - 邮箱：support@yourcompany.com
   - 电话：400-xxx-xxxx
   - 在线支持：控制台右下角帮助中心

   ## 注意事项

   1. 钉钉应用创建后需要一定时间生效，请等待5-10分钟再测试
   2. 修改钉钉应用配置后，需要重新保存平台配置
   3. 建议先在测试环境验证配置，再应用到生产环境
   4. 定期检查钉钉应用凭证有效期（通常长期有效）
